<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Doctor Dashboard — Medisync</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="assets/css/styles.css">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .sidebar {
      min-height: 100vh;
      background: linear-gradient(180deg, #198754 0%, #146c43 100%);
      position: fixed;
      top: 0;
      left: 0;
      width: 250px;
      z-index: 1000;
    }
    .sidebar .nav-link {
      color: rgba(255,255,255,0.8);
      padding: 12px 20px;
      border-radius: 8px;
      margin-bottom: 5px;
      transition: all 0.3s;
    }
    .sidebar .nav-link:hover,
    .sidebar .nav-link.active {
      background: rgba(255,255,255,0.2);
      color: white;
    }
    .main-content {
      margin-left: 250px;
      padding: 20px;
    }
    .stat-card {
      border-left: 4px solid #198754;
      transition: transform 0.3s;
    }
    .stat-card:hover {
      transform: translateY(-5px);
    }
    .profile-avatar {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, #20c997 0%, #198754 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      color: white;
      font-size: 32px;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .patient-card {
      border-left: 4px solid #0dcaf0;
    }
    .appointment-card {
      border-left: 4px solid #ffc107;
    }
  </style>
</head>
<body class="bg-light">

  <!-- Sidebar -->
  <div class="sidebar text-white p-4">
    <div class="text-center mb-4">
      <h4 class="mb-0">Medisync</h4>
      <small>Doctor Portal</small>
    </div>

    <div class="text-center mb-4">
      <div class="profile-avatar mx-auto mb-2">
        <i class="fa fa-user-md"></i>
      </div>
      <h6 class="mb-0" id="sidebarDoctorName">Loading...</h6>
      <small id="sidebarDoctorSpecialty">Loading...</small>
    </div>

    <nav class="nav flex-column">
      <a class="nav-link active" href="#" onclick="showTab('dashboard')">
        <i class="fa fa-home me-2"></i> Dashboard
      </a>
      <a class="nav-link" href="#" onclick="showTab('appointments')">
        <i class="fa fa-calendar me-2"></i> Appointments
      </a>
      <a class="nav-link" href="#" onclick="showTab('patients')">
        <i class="fa fa-users me-2"></i> My Patients
      </a>
      <a class="nav-link" href="#" onclick="showTab('schedule')">
        <i class="fa fa-clock me-2"></i> My Schedule
      </a>
      <a class="nav-link" href="#" onclick="showTab('profile')">
        <i class="fa fa-user me-2"></i> My Profile
      </a>
      <a class="nav-link" href="#" onclick="showTab('settings')">
        <i class="fa fa-cog me-2"></i> Settings
      </a>
      <a class="nav-link" href="#" onclick="logout()">
        <i class="fa fa-sign-out-alt me-2"></i> Logout
      </a>
    </nav>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h3>Welcome, Dr. <span id="doctorName">Doctor</span>!</h3>
        <p class="text-muted mb-0">Here's your practice overview for today</p>
      </div>
      <div>
        <span class="badge bg-success me-2">
          <i class="fa fa-circle me-1"></i> Available
        </span>
        <button class="btn btn-outline-secondary btn-sm">
          <i class="fa fa-bell me-1"></i> Notifications <span class="badge bg-danger">3</span>
        </button>
      </div>
    </div>

    <!-- Dashboard Tab -->
    <div id="dashboard-tab" class="tab-content active">
      <!-- Stats Cards -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="card stat-card shadow-sm">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="text-muted mb-1">Today's Appointments</h6>
                  <h3 class="mb-0" id="todayAppointments">0</h3>
                </div>
                <div class="text-success">
                  <i class="fa fa-calendar-day fa-2x"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card stat-card shadow-sm">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="text-muted mb-1">Total Patients</h6>
                  <h3 class="mb-0" id="totalPatients">0</h3>
                </div>
                <div class="text-info">
                  <i class="fa fa-users fa-2x"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card stat-card shadow-sm">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="text-muted mb-1">Pending Reviews</h6>
                  <h3 class="mb-0" id="pendingReviews">0</h3>
                </div>
                <div class="text-warning">
                  <i class="fa fa-clock fa-2x"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card stat-card shadow-sm">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="text-muted mb-1">Consultations</h6>
                  <h3 class="mb-0" id="totalConsultations">0</h3>
                </div>
                <div class="text-primary">
                  <i class="fa fa-stethoscope fa-2x"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Today's Schedule -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-white">
          <h5 class="mb-0"><i class="fa fa-calendar-check me-2"></i>Today's Schedule</h5>
        </div>
        <div class="card-body">
          <div id="todayScheduleList">
            <div class="text-center py-4">
              <i class="fa fa-spinner fa-spin fa-2x text-muted"></i>
              <p class="text-muted mt-2">Loading schedule...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Recent Patients -->
      <div class="card shadow-sm">
        <div class="card-header bg-white">
          <h5 class="mb-0"><i class="fa fa-users me-2"></i>Recent Patients</h5>
        </div>
        <div class="card-body">
          <div id="recentPatientsList">
            <div class="text-center py-4">
              <i class="fa fa-spinner fa-spin fa-2x text-muted"></i>
              <p class="text-muted mt-2">Loading patients...</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Appointments Tab -->
    <div id="appointments-tab" class="tab-content">
      <div class="card shadow-sm">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="fa fa-calendar me-2"></i>All Appointments</h5>
          <div>
            <select class="form-select form-select-sm" id="appointmentFilter">
              <option value="all">All Status</option>
              <option value="pending">Pending</option>
              <option value="confirmed">Confirmed</option>
              <option value="completed">Completed</option>
              <option value="cancelled">Cancelled</option>
            </select>
          </div>
        </div>
        <div class="card-body">
          <div id="allAppointmentsList">
            <div class="text-center py-4">
              <i class="fa fa-spinner fa-spin fa-2x text-muted"></i>
              <p class="text-muted mt-2">Loading appointments...</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Patients Tab -->
    <div id="patients-tab" class="tab-content">
      <div class="card shadow-sm">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="fa fa-users me-2"></i>My Patients</h5>
          <div>
            <input type="text" class="form-control form-control-sm" placeholder="Search patients..." id="patientSearch">
          </div>
        </div>
        <div class="card-body">
          <div id="patientsList">
            <div class="text-center py-4">
              <i class="fa fa-spinner fa-spin fa-2x text-muted"></i>
              <p class="text-muted mt-2">Loading patients...</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Schedule Tab -->
    <div id="schedule-tab" class="tab-content">
      <div class="card shadow-sm">
        <div class="card-header bg-white">
          <h5 class="mb-0"><i class="fa fa-clock me-2"></i>My Availability Schedule</h5>
        </div>
        <div class="card-body">
          <div id="scheduleContent">
            <div class="table-responsive">
              <table class="table table-bordered">
                <thead class="table-light">
                  <tr>
                    <th>Day</th>
                    <th>Available Slots</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="scheduleTableBody">
                  <tr>
                    <td colspan="4" class="text-center py-4">
                      <i class="fa fa-spinner fa-spin fa-2x text-muted"></i>
                      <p class="text-muted mt-2">Loading schedule...</p>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Profile Tab -->
    <div id="profile-tab" class="tab-content">
      <div class="row">
        <div class="col-md-4">
          <div class="card shadow-sm">
            <div class="card-body text-center">
              <div class="profile-avatar mx-auto mb-3" style="width: 120px; height: 120px; font-size: 48px;">
                <i class="fa fa-user-md"></i>
              </div>
              <h5 id="profileName">Loading...</h5>
              <p class="text-muted" id="profileSpecialty">Loading...</p>
              <p class="text-muted small" id="profileEmail">Loading...</p>
              <button class="btn btn-success btn-sm">Change Photo</button>
            </div>
          </div>
          
          <div class="card shadow-sm mt-3">
            <div class="card-body">
              <h6 class="mb-3">Professional Details</h6>
              <div class="mb-2">
                <small class="text-muted">License Number</small>
                <p class="mb-0" id="profileLicense">Loading...</p>
              </div>
              <div class="mb-2">
                <small class="text-muted">Experience</small>
                <p class="mb-0" id="profileExperience">Loading...</p>
              </div>
              <div class="mb-2">
                <small class="text-muted">Consultation Fee</small>
                <p class="mb-0" id="profileFee">Loading...</p>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-md-8">
          <div class="card shadow-sm">
            <div class="card-header bg-white">
              <h5 class="mb-0"><i class="fa fa-user-edit me-2"></i>Professional Information</h5>
            </div>
            <div class="card-body">
              <form id="profileForm">
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label class="form-label">Full Name</label>
                    <input type="text" class="form-control" id="profileFullName" readonly>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-control" id="profileEmailInput" readonly>
                  </div>
                </div>
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label class="form-label">Phone</label>
                    <input type="tel" class="form-control" id="profilePhone" readonly>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Specialization</label>
                    <input type="text" class="form-control" id="profileSpecializationInput" readonly>
                  </div>
                </div>
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label class="form-label">License Number</label>
                    <input type="text" class="form-control" id="profileLicenseInput" readonly>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Education</label>
                    <input type="text" class="form-control" id="profileEducation" readonly>
                  </div>
                </div>
                <div class="mb-3">
                  <label class="form-label">Bio</label>
                  <textarea class="form-control" id="profileBio" rows="3" readonly></textarea>
                </div>
                <div class="mb-3">
                  <label class="form-label">Languages</label>
                  <input type="text" class="form-control" id="profileLanguages" readonly>
                </div>
                <button type="button" class="btn btn-success" onclick="alert('Edit profile feature coming soon!')">
                  <i class="fa fa-edit me-2"></i>Edit Profile
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings Tab -->
    <div id="settings-tab" class="tab-content">
      <div class="card shadow-sm">
        <div class="card-header bg-white">
          <h5 class="mb-0"><i class="fa fa-cog me-2"></i>Account Settings</h5>
        </div>
        <div class="card-body">
          <h6 class="mb-3">Notification Preferences</h6>
          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" id="emailNotif" checked>
            <label class="form-check-label" for="emailNotif">
              Email notifications for new appointments
            </label>
          </div>
          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" id="smsNotif" checked>
            <label class="form-check-label" for="smsNotif">
              SMS notifications for appointment reminders
            </label>
          </div>
          <div class="form-check mb-4">
            <input class="form-check-input" type="checkbox" id="pushNotif">
            <label class="form-check-label" for="pushNotif">
              Push notifications
            </label>
          </div>
          
          <h6 class="mb-3">Availability Settings</h6>
          <div class="form-check form-switch mb-2">
            <input class="form-check-input" type="checkbox" id="availableToggle" checked>
            <label class="form-check-label" for="availableToggle">
              Currently accepting appointments
            </label>
          </div>
          
          <hr class="my-4">
          
          <h6 class="mb-3">Change Password</h6>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Current Password</label>
                <input type="password" class="form-control">
              </div>
              <div class="mb-3">
                <label class="form-label">New Password</label>
                <input type="password" class="form-control">
              </div>
              <div class="mb-3">
                <label class="form-label">Confirm New Password</label>
                <input type="password" class="form-control">
              </div>
              <button class="btn btn-success">Update Password</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="assets/js/api.js"></script>
  <script>
    // Check if user is logged in
    const token = localStorage.getItem('token');
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    const userType = localStorage.getItem('userType');

    if (!token || !user || userType !== 'doctor') {
      window.location.href = 'doctor_login.html';
    }

    // Display doctor info
    document.getElementById('doctorName').textContent = user.name || 'Doctor';
    document.getElementById('sidebarDoctorName').textContent = 'Dr. ' + (user.name || 'Doctor');
    document.getElementById('sidebarDoctorSpecialty').textContent = user.specialization || 'Specialist';
    document.getElementById('profileName').textContent = 'Dr. ' + (user.name || 'Doctor');
    document.getElementById('profileSpecialty').textContent = user.specialization || '';
    document.getElementById('profileEmail').textContent = user.email || '';
    document.getElementById('profileFullName').value = user.name || '';
    document.getElementById('profileEmailInput').value = user.email || '';
    document.getElementById('profilePhone').value = user.phone || '';
    document.getElementById('profileSpecializationInput').value = user.specialization || '';
    document.getElementById('profileLicense').textContent = user.licenseNumber || 'N/A';
    document.getElementById('profileLicenseInput').value = user.licenseNumber || '';
    document.getElementById('profileEducation').value = user.education || '';
    document.getElementById('profileExperience').textContent = user.experience || 'N/A';
    document.getElementById('profileFee').textContent = '₹' + (user.consultationFee || '0');
    document.getElementById('profileBio').value = user.bio || '';
    document.getElementById('profileLanguages').value = user.languages?.join(', ') || '';

    // Tab switching
    function showTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      document.querySelectorAll('.sidebar .nav-link').forEach(link => {
        link.classList.remove('active');
      });
      
      document.getElementById(tabName + '-tab').classList.add('active');
      event.target.classList.add('active');
      
      if (tabName === 'appointments') {
        loadAllAppointments();
      } else if (tabName === 'patients') {
        loadPatients();
      } else if (tabName === 'schedule') {
        loadSchedule();
      }
    }

    // Load appointments
    async function loadAppointments() {
      try {
        const response = await fetch('http://localhost:5000/api/appointments/doctor', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        const result = await response.json();
        
        if (result.success && result.data) {
          const appointments = result.data;
          
          // Update stats
          const today = new Date().toDateString();
          const todayAppts = appointments.filter(apt => 
            new Date(apt.appointmentDate).toDateString() === today
          );
          document.getElementById('todayAppointments').textContent = todayAppts.length;
          document.getElementById('totalConsultations').textContent = appointments.length;
          
          const pending = appointments.filter(apt => apt.status === 'pending');
          document.getElementById('pendingReviews').textContent = pending.length;
          
          // Display today's schedule
          displayTodaySchedule(todayAppts);
        }
      } catch (error) {
        console.error('Error loading appointments:', error);
      }
    }

    function displayTodaySchedule(appointments) {
      const container = document.getElementById('todayScheduleList');
      
      if (appointments.length === 0) {
        container.innerHTML = `
          <div class="text-center py-4">
            <i class="fa fa-calendar-times fa-2x text-muted mb-3"></i>
            <p class="text-muted">No appointments scheduled for today</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = appointments.map(apt => `
        <div class="card appointment-card mb-3">
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col-md-2">
                <div class="text-center">
                  <h4 class="mb-0">${apt.appointmentTime}</h4>
                  <small class="text-muted">${apt.appointmentType}</small>
                </div>
              </div>
              <div class="col-md-6">
                <h6 class="mb-1">${apt.patient?.name || 'Patient'}</h6>
                <p class="text-muted mb-1"><i class="fa fa-phone me-2"></i>${apt.patient?.phone || 'N/A'}</p>
                <p class="text-muted mb-0"><i class="fa fa-notes-medical me-2"></i>${apt.reason || 'General consultation'}</p>
              </div>
              <div class="col-md-2">
                <span class="badge bg-${getStatusColor(apt.status)}">${apt.status}</span>
              </div>
              <div class="col-md-2">
                <button class="btn btn-sm btn-success w-100 mb-1">Start Consultation</button>
                <button class="btn btn-sm btn-outline-primary w-100">View Details</button>
              </div>
            </div>
          </div>
        </div>
      `).join('');
    }

    function loadAllAppointments() {
      loadAppointments();
    }

    function loadPatients() {
      document.getElementById('patientsList').innerHTML = `
        <div class="text-center py-5">
          <i class="fa fa-users fa-3x text-muted mb-3"></i>
          <h5>Patient List</h5>
          <p class="text-muted">Your patient records will appear here</p>
        </div>
      `;
    }

    function loadSchedule() {
      const schedule = user.availability || [];
      const tbody = document.getElementById('scheduleTableBody');
      
      if (schedule.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="4" class="text-center py-4">
              <i class="fa fa-clock fa-2x text-muted mb-3"></i>
              <p class="text-muted">No schedule configured</p>
            </td>
          </tr>
        `;
        return;
      }
      
      tbody.innerHTML = schedule.map(day => `
        <tr>
          <td><strong>${day.day}</strong></td>
          <td>${day.slots?.join(', ') || 'No slots'}</td>
          <td><span class="badge bg-success">Active</span></td>
          <td>
            <button class="btn btn-sm btn-outline-primary">Edit</button>
          </td>
        </tr>
      `).join('');
    }

    function getStatusColor(status) {
      const colors = {
        'confirmed': 'success',
        'pending': 'warning',
        'completed': 'info',
        'cancelled': 'danger'
      };
      return colors[status] || 'secondary';
    }

    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        localStorage.removeItem('userType');
        window.location.href = 'doctor_login.html';
      }
    }

    // Load data on page load
    loadAppointments();
    
    // Get unique patients count
    fetch('http://localhost:5000/api/appointments/doctor', {
      headers: { 'Authorization': `Bearer ${token}` }
    })
    .then(res => res.json())
    .then(result => {
      if (result.success) {
        const uniquePatients = new Set(result.data.map(apt => apt.patient?._id)).size;
        document.getElementById('totalPatients').textContent = uniquePatients;
      }
    });
  </script>
</body>
</html>
